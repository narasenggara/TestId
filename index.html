<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>OCR KTP</title>
  <script src="https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js"></script>
  <style>
    body { font-family: Arial, sans-serif; padding: 20px; }
    h2 { margin-top: 20px; }
    img { max-width: 300px; margin: 10px; border: 1px solid #ccc; }
    pre { background: #f4f4f4; padding: 10px; max-height: 200px; overflow-y: auto; }
    table { border-collapse: collapse; width: 100%; margin-top: 10px; }
    td, th { border: 1px solid #333; padding: 6px; }
  </style>
</head>
<body>
  <h1>OCR KTP</h1>
  <input type="file" id="upload" accept="image/*"><br><br>

  <h2>Preview</h2>
  <div>
    <img id="originalPreview" alt="Foto Asli">
    <img id="processedPreview" alt="Foto Diproses">
  </div>

  <h2>Hasil OCR Mentah</h2>
  <pre id="rawText">-</pre>

  <h2>Hasil Parsing KTP</h2>
  <table>
    <tbody>
      <tr><th>NIK</th><td id="nik"></td></tr>
      <tr><th>Nama</th><td id="nama"></td></tr>
      <tr><th>Tempat Lahir</th><td id="tempat"></td></tr>
      <tr><th>Tanggal Lahir</th><td id="tgl"></td></tr>
      <tr><th>Jenis Kelamin</th><td id="jk"></td></tr>
      <tr><th>Alamat</th><td id="alamat"></td></tr>
      <tr><th>RT</th><td id="rt"></td></tr>
      <tr><th>RW</th><td id="rw"></td></tr>
      <tr><th>Kel/Desa</th><td id="kel"></td></tr>
      <tr><th>Kecamatan</th><td id="kec"></td></tr>
      <tr><th>Pekerjaan</th><td id="pekerjaan"></td></tr>
      <tr><th>Kewarganegaraan</th><td id="wni"></td></tr>
      <tr><th>Kota</th><td id="kota"></td></tr>
    </tbody>
  </table>

  <script>
    const upload = document.getElementById("upload");
    const originalPreview = document.getElementById("originalPreview");
    const processedPreview = document.getElementById("processedPreview");
    const rawTextEl = document.getElementById("rawText");

    upload.addEventListener("change", async (e) => {
      const file = e.target.files[0];
      if (!file) return;

      const reader = new FileReader();
      reader.onload = function(ev) {
        originalPreview.src = ev.target.result;

        // Buat canvas untuk preprocessing
        const img = new Image();
        img.src = ev.target.result;
        img.onload = () => {
          const canvas = document.createElement("canvas");
          const ctx = canvas.getContext("2d");
          canvas.width = img.width;
          canvas.height = img.height;
          ctx.drawImage(img, 0, 0);

          // Ambil pixel â†’ ubah ke grayscale + threshold
          const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
          const data = imageData.data;
          for (let i = 0; i < data.length; i += 4) {
            const avg = (data[i] + data[i+1] + data[i+2]) / 3;
            const val = avg > 150 ? 255 : 0; // threshold
            data[i] = data[i+1] = data[i+2] = val;
          }
          ctx.putImageData(imageData, 0, 0);

          processedPreview.src = canvas.toDataURL();

          // Jalankan OCR di gambar hasil processing
          Tesseract.recognize(canvas.toDataURL(), "ind", {
            logger: m => console.log(m)
          }).then(({ data: { text } }) => {
            rawTextEl.textContent = text;
            parseKTP(text);
          });
        };
      };
      reader.readAsDataURL(file);
    });

    function parseKTP(text) {
      function findLine(keyword) {
        const regex = new RegExp(keyword + "[\\s:]*([^\n]+)", "i");
        const match = text.match(regex);
        return match ? match[1].trim() : "";
      }

      document.getElementById("nik").textContent = (text.match(/\d{16}/) || [""])[0];
      document.getElementById("nama").textContent = findLine("Nama");
      let ttl = findLine("Tempat|Lahir|TTL");
      let [tempat, tgl] = ttl.split(/[, ]+/);
      document.getElementById("tempat").textContent = tempat || "";
      document.getElementById("tgl").textContent = tgl || "";
      document.getElementById("jk").textContent = findLine("Kelamin");
      document.getElementById("alamat").textContent = findLine("Alamat");
      let rtRw = findLine("RT|Rw");
      if (rtRw.includes("/")) {
        let [rt, rw] = rtRw.split("/");
        document.getElementById("rt").textContent = rt || "";
        document.getElementById("rw").textContent = rw || "";
      }
      document.getElementById("kel").textContent = findLine("Kel|Desa");
      document.getElementById("kec").textContent = findLine("Kec");
      document.getElementById("pekerjaan").textContent = findLine("Kerja|Pekerjaan");
      document.getElementById("wni").textContent = findLine("WNI|Warga");
      let kota = findLine("Kota|Kabupaten|Kab");
      if (kota.toUpperCase() === "BANDUNG") kota = "Kab. Bandung";
      document.getElementById("kota").textContent = kota;
    }
  </script>
</body>
</html>

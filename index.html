<!DOCTYPE html><html lang="id">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>OCR KTP – Extractor</title>
  <script src="https://cdn.jsdelivr.net/npm/tesseract.js@4/dist/tesseract.min.js"></script>
  <script>
    // --- Helper: debounce ---
    const debounce = (fn, wait=400) => { let t; return (...args)=>{ clearTimeout(t); t=setTimeout(()=>fn(...args), wait); }; };// --- Image pre-processing: grayscale + contrast via canvas ---
async function preprocessImage(file) {
  const img = await createImageBitmap(file);
  const canvas = document.createElement('canvas');
  const maxW = 1600; // downscale for faster OCR but keep quality
  const scale = Math.min(1, maxW / img.width);
  canvas.width = Math.floor(img.width * scale);
  canvas.height = Math.floor(img.height * scale);
  const ctx = canvas.getContext('2d');
  ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
  const { data, width, height } = ctx.getImageData(0,0,canvas.width,canvas.height);
  // grayscale + simple contrast stretch
  for (let i=0; i<data.length; i+=4){
    const gray = data[i]*0.2126 + data[i+1]*0.7152 + data[i+2]*0.0722;
    // simple contrast adjustment
    const contrasted = Math.max(0, Math.min(255, (gray-128)*1.15 + 128));
    data[i]=data[i+1]=data[i+2]=contrasted;
  }
  const imgData = new ImageData(data, width, height);
  ctx.putImageData(imgData, 0, 0);
  return canvas;
}

// --- Parsing utilities ---
function normalize(text){
  return text
    .replace(/[\u00A0\t]/g, ' ')     // nbsp, tabs -> spasi
    .replace(/\r/g, '')
    .replace(/[|]/g, 'I')              // OCR sering baca | menjadi I dan sebaliknya
    .replace(/\s{2,}/g, ' ')          // spasi ganda -> tunggal
    .toUpperCase();
}

function getLineValue(lines, patterns) {
  const re = new RegExp(`^(?:${patterns.join('|')})\s*[:.-]?\s*(.+)$`, 'i');
  for (const raw of lines) {
    const line = raw.trim();
    const m = line.match(re);
    if (m) return m[1].trim();
  }
  return '';
}

function findByContains(lines, keywords) {
  for (const raw of lines) {
    const line = raw.trim();
    if (keywords.every(k=> line.includes(k))) return line;
  }
  return '';
}

function parseKTP(text){
  const clean = normalize(text);
  const lines = clean.split('\n').map(s=>s.trim()).filter(Boolean);

  // Nama
  let nama = getLineValue(lines, ['NAMA']);
  // Tempat/Tgl Lahir (beragam label)
  let ttlLine = getLineValue(lines, ['TEMPAT\/TGL LAHIR', 'TEMPAT\/TANGGAL LAHIR', 'TPT\/TGL LAHIR', 'TTL']);
  if (!ttlLine){
    const alt = findByContains(lines, ['LAHIR']);
    if (alt){ ttlLine = alt.replace(/.*LAHIR\s*[:.-]?\s*/,'').trim(); }
  }

  // Pecah tempat & tanggal
  let tempatLahir = '', tanggalLahir = '';
  if (ttlLine){
    // coba deteksi tanggal
    const dateRegexes = [
      /(\d{2}[\/-]\d{2}[\/-]\d{2,4})/,                 // 01-01-1990 atau 01/01/90
      /(\d{1,2}\s+[A-Z]+\s+\d{4})/,                    // 1 JANUARI 1990
      /(\d{2}-[A-Z]{3}-\d{4})/                           // 01-JAN-1990
    ];
    let dm=null;
    for (const r of dateRegexes){ const m=ttlLine.match(r); if(m){ dm=m[1]; break; } }
    if (dm){
      tanggalLahir = dm;
      tempatLahir = ttlLine.replace(dm,'').replace(/[ ,;-]+$/,'').replace(/^[ ,;-]+/,'').trim();
      if (!tempatLahir){
        // fallback: sebelum koma
        const s = ttlLine.split(',');
        tempatLahir = s[0]||''; tanggalLahir = s[1] ? s[1].trim(): tanggalLahir;
      }
    } else {
      // fallback pola "KOTA, DD-MM-YYYY"
      const parts = ttlLine.split(',');
      if (parts.length>=2){ tempatLahir = parts[0].trim(); tanggalLahir = parts.slice(1).join(',').trim(); }
      else { tempatLahir = ttlLine.trim(); }
    }
  }

  // Kel/Desa
  let kel = getLineValue(lines, ['KEL\/?DESA', 'KEL', 'KELURAHAN', 'DESA']);
  // Kecamatan
  let kec = getLineValue(lines, ['KEC', 'KECAMATAN']);
  // Kota/Kabupaten (beragam label)
  let kota = getLineValue(lines, ['KOTA', 'KAB\.?', 'KABUPATEN', 'KOTA\/KAB']);

  // Jenis Kelamin
  let jk = getLineValue(lines, ['JENIS KELAMIN', 'JK']);
  if (!jk){
    const l = findByContains(lines, ['LAKI']) || findByContains(lines, ['PEREMPUAN']) || '';
    if (l) jk = l.replace(/.*JENIS KELAMIN\s*[:.-]?\s*/,'').trim();
  }
  // Normalisasi nilai JK
  if (/L(AKI)?-?L(AKI)?|\bL\b/.test(jk)) jk = 'LAKI-LAKI';
  else if (/PEREMPUAN|\bP\b/.test(jk)) jk = 'PEREMPUAN';

  // Bersihkan trailing label kejadian OCR (misal ikut RT/RW di baris sama)
  const stripAfter = v => v.replace(/\s+RT.*$/,'').replace(/\s+RW.*$/,'').trim();
  kel = stripAfter(kel); kec = stripAfter(kec); kota = stripAfter(kota);

  return { nama, tempatLahir, tanggalLahir, kelurahan: kel, kecamatan: kec, kota, jenisKelamin: jk, raw: clean };
}

async function runOCR(file, onProgress){
  const canvas = await preprocessImage(file);
  const blob = await new Promise(res=> canvas.toBlob(res, 'image/png', 0.95));
  const { data } = await Tesseract.recognize(blob, 'ind', { logger: onProgress });
  return data.text;
}

function toCSV(obj){
  const headers = ['Nama','Tempat Lahir','Tanggal Lahir','Kelurahan','Kecamatan','Kota','Jenis Kelamin'];
  const row = [obj.nama, obj.tempatLahir, obj.tanggalLahir, obj.kelurahan, obj.kecamatan, obj.kota, obj.jenisKelamin]
    .map(v=>`"${(v||'').replace(/"/g,'\"')}"`).join(',');
  return headers.join(',') + '\n' + row + '\n';
}

async function handleFile(file){
  const logEl = document.getElementById('log');
  logEl.textContent = '';
  const writeLog = (m)=>{ logEl.textContent = m.progress ? `${(m.progress*100).toFixed(0)}% – ${m.status}` : m.status };

  document.getElementById('preview').src = URL.createObjectURL(file);
  document.getElementById('raw').textContent = 'Memproses OCR...';
  const text = await runOCR(file, writeLog);
  document.getElementById('raw').textContent = text;

  const parsed = parseKTP(text);
  const fields = [
    ['nama', 'Nama'],
    ['tempatLahir', 'Tempat Lahir'],
    ['tanggalLahir', 'Tanggal Lahir'],
    ['kelurahan', 'Kelurahan'],
    ['kecamatan', 'Kecamatan'],
    ['kota', 'Kota'],
    ['jenisKelamin', 'Jenis Kelamin']
  ];
  for (const [key, label] of fields){
    document.querySelector(`[data-field="${key}"]`).textContent = parsed[key] || '-';
  }

  // enable actions
  document.getElementById('copyText').onclick = ()=>{
    const lines = fields.map(([k,l]) => `${l}: ${parsed[k]||''}`).join('\n');
    navigator.clipboard.writeText(lines);
  };
  document.getElementById('copyJSON').onclick = ()=>{
    const out = { Nama: parsed.nama, 'Tempat Lahir': parsed.tempatLahir, 'Tanggal Lahir': parsed.tanggalLahir, Kelurahan: parsed.kelurahan, Kecamatan: parsed.kecamatan, Kota: parsed.kota, 'Jenis Kelamin': parsed.jenisKelamin };
    navigator.clipboard.writeText(JSON.stringify(out, null, 2));
  };
  document.getElementById('downloadCSV').onclick = ()=>{
    const blob = new Blob([toCSV(parsed)], { type: 'text/csv' });
    const a = Object.assign(document.createElement('a'), { href: URL.createObjectURL(blob), download: 'hasil_ktp.csv' });
    a.click();
  };
}

window.addEventListener('DOMContentLoaded', ()=>{
  const input = document.getElementById('file');
  input.addEventListener('change', e=> {
    const f = e.target.files && e.target.files[0];
    if (f) handleFile(f);
  });
  // drag & drop
  const drop = document.getElementById('drop');
  drop.addEventListener('dragover', e=>{ e.preventDefault(); drop.classList.add('drag'); });
  drop.addEventListener('dragleave', ()=> drop.classList.remove('drag'));
  drop.addEventListener('drop', e=>{ e.preventDefault(); drop.classList.remove('drag'); const f = e.dataTransfer.files[0]; if(f) handleFile(f); });
});

  </script>
  <style>
    :root { color-scheme: light dark; --bg:#0b1020; --card:#111629; --muted:#64748b; }
    body{ font-family: system-ui, -apple-system, Segoe UI, Roboto, 'Inter', Arial; margin:0; padding:24px; background:linear-gradient(180deg,#0b1020,#0b1020 200px,#0f172a 200px,#0f172a); color:#e2e8f0 }
    h1{ margin:0 0 6px; font-size:22px }
    .wrap{ max-width:980px; margin:0 auto }
    .card{ background:rgba(255,255,255,0.04); border:1px solid rgba(255,255,255,0.08); border-radius:16px; padding:16px; box-shadow: 0 8px 24px rgba(0,0,0,0.25); }
    .grid{ display:grid; gap:16px; grid-template-columns: 1.2fr 1fr; }
    #drop{ border:2px dashed rgba(255,255,255,0.2); border-radius:14px; padding:18px; text-align:center; cursor:pointer; }
    #drop.drag{ border-color:#93c5fd; background:rgba(147,197,253,0.08) }
    button{ padding:10px 14px; border-radius:12px; border:1px solid rgba(255,255,255,0.2); background:#1f2937; color:#e5e7eb; cursor:pointer }
    button:hover{ background:#374151 }
    .kv{ display:grid; grid-template-columns: 160px 1fr; gap:8px 12px; align-items:center }
    .label{ color:#94a3b8 }
    img{ max-width:100%; border-radius:12px; border:1px solid rgba(255,255,255,0.08) }
    pre{ white-space:pre-wrap; word-break:break-word; background:#0b1327; border:1px solid rgba(255,255,255,0.08); padding:12px; border-radius:12px; max-height:260px; overflow:auto }
    small{ color:#94a3b8 }
    a.link{ color:#93c5fd; text-decoration:none }
  </style>
</head>
<body>
  <div class="wrap">
    <h1>OCR KTP (Client‑Side)</h1>
    <p class="card" style="margin-bottom:16px">
      <strong>Privasi:</strong> proses OCR 100% di browser kamu (tidak diunggah ke server). Untuk contoh, <em>disarankan</em> menutup NIK/face terlebih dahulu.
    </p>
    <div class="grid">
      <div class="card">
        <div id="drop">
          <p><strong>Tarik & lepas</strong> foto KTP di sini, atau</p>
          <label>
            <input id="file" type="file" accept="image/*" style="display:none" />
            <button>Pilih Gambar</button>
          </label>
          <p><small>Tips: pastikan teks tajam, tidak blur, dan tidak miring.</small></p>
        </div>
        <div style="margin-top:12px">
          <img id="preview" alt="Preview KTP" />
        </div>
        <p style="margin:12px 0 6px"><small id="log">Menunggu gambar…</small></p>
        <pre id="raw">Teks OCR akan tampil di sini…</pre>
      </div>
      <div class="card">
        <h3 style="margin-top:0">Data Hasil Ekstraksi</h3>
        <div class="kv">
          <div class="label">Nama</div><div data-field="nama">-</div>
          <div class="label">Tempat Lahir</div><div data-field="tempatLahir">-</div>
          <div class="label">Tanggal Lahir</div><div data-field="tanggalLahir">-</div>
          <div class="label">Kelurahan</div><div data-field="kelurahan">-</div>
          <div class="label">Kecamatan</div><div data-field="kecamatan">-</div>
          <div class="label">Kota</div><div data-field="kota">-</div>
          <div class="label">Jenis Kelamin</div><div data-field="jenisKelamin">-</div>
        </div>
        <div style="display:flex; gap:8px; margin-top:14px">
          <button id="copyText">Salin (Text)</button>
          <button id="copyJSON">Salin (JSON)</button>
          <button id="downloadCSV">Unduh CSV</button>
        </div>
        <p><small>Catatan: Format KTP dapat sedikit berbeda ("KEL/ DESA", "KAB."). Parser ini mencoba beberapa variasi label umum. Kamu bisa modifikasi regex di bagian <code>parseKTP()</code>.</small></p>
      </div>
    </div>
    <p style="opacity:.85; margin-top:14px"><small>Built with <a class="link" href="https://tesseract.projectnaptha.com/" target="_blank" rel="noreferrer">Tesseract.js</a>. Tidak memerlukan server.</small></p>
  </div>
</body>
</html>

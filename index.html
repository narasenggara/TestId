<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>OCR KTP</title>
  <script src="https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js"></script>
  <style>
    body { font-family: Arial, sans-serif; padding: 20px; }
    #preview { max-width: 100%; margin-top: 10px; border: 1px solid #ccc; }
    table { margin-top: 20px; border-collapse: collapse; width: 100%; }
    td, th { border: 1px solid #666; padding: 6px; text-align: left; }
    #status { margin-top: 10px; font-weight: bold; }
  </style>
</head>
<body>
  <h2>Upload Foto KTP</h2>
  <input type="file" id="upload" accept="image/*"><br>
  <img id="preview" alt="Preview Foto"><br>
  <div id="status"></div>

  <h3>Hasil OCR:</h3>
  <table>
    <tr><th>NIK</th><td id="nik"></td></tr>
    <tr><th>Nama</th><td id="nama"></td></tr>
    <tr><th>Tempat Lahir</th><td id="tempat"></td></tr>
    <tr><th>Tanggal Lahir</th><td id="tgl"></td></tr>
    <tr><th>Jenis Kelamin</th><td id="jk"></td></tr>
    <tr><th>Alamat</th><td id="alamat"></td></tr>
    <tr><th>RT</th><td id="rt"></td></tr>
    <tr><th>RW</th><td id="rw"></td></tr>
    <tr><th>Kel/Desa</th><td id="kel"></td></tr>
    <tr><th>Kecamatan</th><td id="kec"></td></tr>
    <tr><th>Pekerjaan</th><td id="pekerjaan"></td></tr>
    <tr><th>Kewarganegaraan</th><td id="wni"></td></tr>
    <tr><th>Kota</th><td id="kota"></td></tr>
  </table>

  <script>
    const upload = document.getElementById('upload');
    const preview = document.getElementById('preview');
    const statusEl = document.getElementById('status');

    upload.addEventListener('change', async (e) => {
      const file = e.target.files[0];
      if (!file) return;

      const reader = new FileReader();
      reader.onload = async function(ev) {
        preview.src = ev.target.result;
        statusEl.innerText = "Sedang membaca teks...";

        try {
          const { data: { text } } = await Tesseract.recognize(
            ev.target.result, 
            'ind',
            { logger: m => statusEl.innerText = m.status + " " + Math.round((m.progress||0)*100) + "%" }
          );
          
          statusEl.innerText = "Selesai!";
          parseKTP(text);

        } catch (err) {
          statusEl.innerText = "OCR Error: " + err.message;
        }
      };
      reader.readAsDataURL(file);
    });

    function parseKTP(raw) {
      const clean = raw.replace(/\s+/g, " ").toUpperCase();

      // regex extract
      const nik = (clean.match(/\b\d{16}\b/)||[""])[0];
      const nama = (clean.match(/NAMA[: ]([A-Z ]+)/)||["",""])[1];
      const ttl = (clean.match(/TEMPAT\/TGL LAHIR[: ]([A-Z ]+), (\d{2}-\d{2}-\d{4})/)||["","",""]);
      const jk = (clean.match(/JENIS KELAMIN[: ](LAKI-LAKI|PEREMPUAN)/)||["",""])[1];
      const alamat = (clean.match(/ALAMAT[: ]([A-Z0-9 .\/-]+)/)||["",""])[1];
      const rtrw = (clean.match(/RT ?(\d{1,3}) ?\/ ?RW ?(\d{1,3})/)||["","",""]);
      const kel = (clean.match(/KEL\/DESA[: ]([A-Z ]+)/)||["",""])[1];
      const kec = (clean.match(/KECAMATAN[: ]([A-Z ]+)/)||["",""])[1];
      const pekerjaan = (clean.match(/PEKERJAAN[: ]([A-Z ]+)/)||["",""])[1];
      const wni = clean.includes("WNI") ? "WNI" : (clean.includes("WNA") ? "WNA" : "");
      const kota = (clean.match(/KOTA [A-Z ]+|KABUPATEN [A-Z ]+/)||[""])[0];

      // isi tabel
      document.getElementById("nik").innerText = nik;
      document.getElementById("nama").innerText = nama;
      document.getElementById("tempat").innerText = ttl[1];
      document.getElementById("tgl").innerText = ttl[2];
      document.getElementById("jk").innerText = jk;
      document.getElementById("alamat").innerText = alamat;
      document.getElementById("rt").innerText = rtrw[1];
      document.getElementById("rw").innerText = rtrw[2];
      document.getElementById("kel").innerText = kel;
      document.getElementById("kec").innerText = kec;
      document.getElementById("pekerjaan").innerText = pekerjaan;
      document.getElementById("wni").innerText = wni;
      document.getElementById("kota").innerText = kota;
    }
  </script>
</body>
</html>

<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>OCR KTP</title>
  <script src="https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js"></script>
  <style>
    body { font-family: Arial, sans-serif; padding: 20px; }
    #preview { max-width: 100%; margin-top: 10px; border: 1px solid #ccc; }
    table { margin-top: 20px; border-collapse: collapse; width: 100%; }
    td, th { border: 1px solid #666; padding: 6px; text-align: left; }
  </style>
</head>
<body>
  <h2>Upload Foto KTP</h2>
  <input type="file" id="upload" accept="image/*"><br>
  <img id="preview" alt="Preview Foto"><br>
  <div id="status"></div>

  <h3>Hasil OCR:</h3>
  <table>
    <tr><th>NIK</th><td id="nik"></td></tr>
    <tr><th>Nama</th><td id="nama"></td></tr>
    <tr><th>Tempat Lahir</th><td id="tempat"></td></tr>
    <tr><th>Tanggal Lahir</th><td id="tgl"></td></tr>
    <tr><th>Jenis Kelamin</th><td id="jk"></td></tr>
    <tr><th>Alamat</th><td id="alamat"></td></tr>
    <tr><th>RT</th><td id="rt"></td></tr>
    <tr><th>RW</th><td id="rw"></td></tr>
    <tr><th>Kel/Desa</th><td id="kel"></td></tr>
    <tr><th>Kecamatan</th><td id="kec"></td></tr>
    <tr><th>Pekerjaan</th><td id="pekerjaan"></td></tr>
    <tr><th>Kewarganegaraan</th><td id="wni"></td></tr>
    <tr><th>Kota</th><td id="kota"></td></tr>
  </table>

  <script>
    const upload = document.getElementById('upload');
    const preview = document.getElementById('preview');
    const statusEl = document.getElementById('status');

    upload.addEventListener('change', async (e) => {
      const file = e.target.files[0];
      if (!file) return;

      // tampilkan preview
      const reader = new FileReader();
      reader.onload = async function(ev) {
        preview.src = ev.target.result;
        statusEl.innerText = "Sedang membaca teks...";

        try {
          const { data: { text } } = await Tesseract.recognize(
            ev.target.result, 
            'ind',
            { logger: m => statusEl.innerText = m.status + " " + Math.round((m.progress||0)*100) + "%" }
          );
          
          statusEl.innerText = "Selesai!";
          parseKTP(text);

        } catch (err) {
          statusEl.innerText = "OCR Error: " + err.message;
        }
      };
      reader.readAsDataURL(file);
    });

    function parseKTP(raw) {
      const lines = raw.split("\n").map(l => l.trim()).filter(l => l);

      function getLine(key) {
        return lines.find(l => l.toUpperCase().includes(key)) || "";
      }

      document.getElementById("nik").innerText = getLine("NIK").replace(/NIK[: ]?/i, "");
      document.getElementById("nama").innerText = getLine("NAMA").replace(/NAMA[: ]?/i, "");

      const ttl = getLine("TEMPAT").replace(/TEMPAT.?TGL.?LAHIR[: ]?/i,"");
      if (ttl.includes(",")) {
        const [t, d] = ttl.split(",");
        document.getElementById("tempat").innerText = t.trim();
        document.getElementById("tgl").innerText = d.trim();
      }

      document.getElementById("jk").innerText = getLine("KELAMIN").replace(/JENIS KELAMIN[: ]?/i,"");
      document.getElementById("alamat").innerText = getLine("ALAMAT").replace(/ALAMAT[: ]?/i,"");

      const rtrw = getLine("RT");
      if (rtrw.includes("/")) {
        const [rt, rw] = rtrw.split("/");
        document.getElementById("rt").innerText = rt.replace(/\D/g,"");
        document.getElementById("rw").innerText = rw.replace(/\D/g,"");
      }

      document.getElementById("kel").innerText = getLine("KEL").replace(/KEL.?DESA[: ]?/i,"");
      document.getElementById("kec").innerText = getLine("KECAMATAN").replace(/KECAMATAN[: ]?/i,"");
      document.getElementById("pekerjaan").innerText = getLine("PEKERJAAN").replace(/PEKERJAAN[: ]?/i,"");
      document.getElementById("wni").innerText = getLine("WNI") ? "WNI" : "";

      const kota = lines.find(l => l.toUpperCase().includes("KOTA") || l.toUpperCase().includes("BANDUNG"));
      if (kota && kota.toUpperCase().includes("KOTA")) {
        document.getElementById("kota").innerText = kota;
      } else if (kota) {
        document.getElementById("kota").innerText = "Kab. " + kota;
      }
    }
  </script>
</body>
</html>
